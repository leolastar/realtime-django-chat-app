<!DOCTYPE html>
<html>
  <body>
    <h1>Chat Room {{ conversation.id }}</h1>
    <a href="{% url 'chat_list' %}">Back to Chat List</a>
    <div
      id="chat-box"
      class="border 1px solid #ccc rounded p-3 mb-2"
      style="height: 400px; overflow-y: scroll"
    >
      {% for msg in messages %}
      <div class="mb-1"><strong>{{ msg.user }}:</strong> {{ msg.message }}</div>
      {% empty %}
      <p>No messages yet.</p>
      {% endfor %}
    </div>
    <div id="typing-indicator" class="fst-italic mb-1"></div>
    <input
      type="text"
      id="msg-input"
      class="form-control"
      placeholder="Type your message..."
    />
    <button id="send-btn" class="btn btn-primary mt-2">Send</button>

    <script>
      const convId = "{{ conversation.id }}";
      const wsUrl = `ws://${location.host}/ws/chat/${convId}/`;
      const socket = new WebSocket(wsUrl);

      const user_id = localStorage.getItem("user_id");

      socket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log("chat_room.html data", data);

        if (data.type === "chat.join") {
          const chatBox = document.getElementById("chat-box");
          if (data.message.user_id === parseInt(user_id)) {
            const messages = JSON.parse(data.messages);
            console.log("chat_room.html messages", messages);
            messages.forEach((msg) => {
              chatBox.innerHTML += `<div class="mb-1"><strong>${msg.user}:</strong> ${msg.message}</div>`;
            });
            chatBox.scrollTop = chatBox.scrollHeight;
            return;
          }
          const msg = data.message;
          chatBox.innerHTML += `<div class="mb-1"><strong>${msg.user}:</strong> joined the chat</div>`;
          chatBox.scrollTop = chatBox.scrollHeight;
          document.getElementById("typing-indicator").innerText = "";
        } else if (data.type === "chat.message") {
          const msg = data.message;
          const chatBox = document.getElementById("chat-box");
          chatBox.innerHTML += `<div class="mb-1"><strong>${msg.user}:</strong> ${msg.message}</div>`;
          chatBox.scrollTop = chatBox.scrollHeight;
          document.getElementById("typing-indicator").innerText = "";
        } else if (data.type === "chat.typing") {
          if (data.user_id === parseInt(user_id)) {
            return;
          }

          document.getElementById(
            "typing-indicator"
          ).innerText = `${data.user} is typing...`;
        } else if (data.type === "chat.stop_typing") {
          document.getElementById("typing-indicator").innerText = "";
        } else if (data.type === "chat.history") {
          // Load history (already rendered server side)
        } else if (data.type === "chat.leave") {
          if (data.user_id === parseInt(user_id)) {
            return;
          }
          const chatBox = document.getElementById("chat-box");
          chatBox.innerHTML += `<div class="mb-1"><strong>${data.user}:</strong> ${data.user} left the chat</div>`;
          chatBox.scrollTop = chatBox.scrollHeight;
          document.getElementById("typing-indicator").innerText = "";
          socket.close();
        }
      };

      // Join room
      socket.onopen = function () {
        socket.send(JSON.stringify({ type: "join", conversation_id: convId }));
      };

      const sendBtn = document.getElementById("send-btn");
      const msgInput = document.getElementById("msg-input");

      sendBtn.onclick = () => {
        const content = msgInput.value.trim();
        if (!content) return;
        socket.send(
          JSON.stringify({
            type: "message",
            conversation_id: convId,
            content: content,
          })
        );
        msgInput.value = "";
      };

      msgInput.addEventListener("input", () => {
        if (msgInput.value.trim() !== "") {
          socket.send(
            JSON.stringify({ type: "typing", conversation_id: convId })
          );
        } else {
          socket.send(
            JSON.stringify({ type: "stop_typing", conversation_id: convId })
          );
        }
      });

      window.addEventListener("beforeunload", () => {
        socket.send(JSON.stringify({ type: "leave", conversation_id: convId }));
      });
    </script>
  </body>
</html>
